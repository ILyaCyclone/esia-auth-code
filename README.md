Приложение демонстрирует авторизацию пользователя в системе ЕСИА (Госуслуги) с использованием OAuth2 и получение его
персональных данных.

Актуальная версия "Методических рекомендаций по использованию Единой системы идентификации и аутентификации": 2.80.

## Подготовка

Предполагается, что регистрация системы в ЕСИА выполнена, и контейнер с сертификатом и приватным ключом получен.

### ПО

Используется java-криптопровайдер КриптоПро JCP версии 2.0.41789-R4 и Java 8.

КриптоПро JCP должен быть установлен в JDK (JRE), в которой запускается данное приложение.

Для Windows и Java 8 установка КриптоПро JCP может быть выполнена при помощи `setup.exe` в скаченном дистрибутиве.

### Ключевой контейнер

Ключевой контейнер КриптоПро читается из файловой системы.  
Расположение в файловой системе можно указать в GUI КриптоПро JCP - вкладка Hardware, пункт Path to HDImage store.

Для Windows стандартное расположение `%USERPROFILE%\AppData\Local\Crypto Pro\`, куда необходимо поместить директорию с
контейнером.

Убедитесь, что Вы видите контейнер с ключом и сертификатом в GUI КриптоПро JCP во вкладке Keys and certificates stores
(Хранилища ключей и сертификатов) в папке HDImageStore.

### Публичный сертификат

Для верификации полученных от ЕСИА JWT требуется публичный сертификат ЕСИА.

Архив с публичными сертификатами для продуктивной и тестовой сред можно скачать по ссылке
http://esia.gosuslugi.ru/public/esia.zip (ссылка указана в документации ЕСИА в пункте "3.1.2 Аутентификация с
использованием OpenID Connect 1.0").  
Распакуйте архив и расположите файл с публичным сертификатом (например, RSA_TESIA.cer для тестовой среды) в файловой
системе.

## Конфигурация

Для работы приложения требуются следующие переменные среды:

Переменная | Описание
--- | ---
ESIA_ENVIRONMENT | используемая среда ЕСИА, значения `prod`, `test`
ESIA_SCOPES | список scope через запятую (пример: fullname, id_doc, email)
ESIA_CLIENT_ID | идентификатор системы-клиента (мнемоника системы в ЕСИА)
ESIA_CLIENT_CERTIFICATE_HASH | хэш сертификата (fingerprint сертификата) системы-клиента в hex-формате
ESIA_KEYSTORE_ALIAS | алиас ключевой пары в контейнере
ESIA_KEYSTORE_PASSWORD | пароль ключевой пары в контейнере
ESIA_CERTIFICATE_PATH | путь в файловой системе к файлу с публичным сертификатом ЕСИА

Дополнительно:

Переменная | Описание | Значение по умолчанию
--- | --- | ---
ESIA_CONNECT_TIMEOUT | таймаут установки соединения HTTP-запроса к ЕСИА (значение в Duration<sup>1</sup>) | 1m
ESIA_CLIENT_ID | таймаут чтения ответа HTTP-запроса к ЕСИА (значение в Duration<sup>1</sup>) | 1m
ESIA_RETURN_URL | URL возврата после прохождения авторизации в ЕСИА | http://localhost:${server.port}${server.servlet.context-path}/login/oauth2/code/esia_debug
ESIA_CABINET_REDIRECT_URL | URL редиректа в приложение Cabinet | http://wl3n3.miit.ru:7003/cabinet/token_auth_callback

Логирование:

esia.logging.console.format - plaintext, json, off (default: plaintext)  
esia.logging.console.json.pretty - true, false (default: true)  
esia.logging.file.plaintext.enabled - true, false (default: false)  
esia.logging.file.json.enabled - true, false (default: false)  
esia.logging.file.json.pretty - true, false (default: false)

## Запуск

Для запуска выполните `mvn spring-boot:run` или используйте любой другой способ запуска Spring Boot приложения.  
Помните, что для запуска необходима JDK (JRE) с установленным КриптоПро JCP.

После запуска откройте в браузере http://localhost:8080.  
Нажмите `login with esia`. Пройдите авторизацию (тестовой) записью и подтвердите запрошенные разрешения.  
Вы будете перенаправлены обратно на страницу приложения.

При успехе Вы увидите авторизационный код, маркер доступа, а также персональные

При неудаче - сообщение об ошибке и описание ошибки.

## Troubleshooting

- ESIA-007005: The client is not authorized to request an access token using this method.

Вводящая в заблуждение формулировка сообщения об ошибке. Вероятнее всего некорректно сформирован параметр `client_secret`.  
Возможно, Вы используете незарегистрированный в ЕСИА сертификат или неподдерживаемый алгоритм формирования подписи.

- ESIA-007014: The request doesn`t contain the mandatory parameter [timestamp].

Такое сообщение об ошибке может быть получено, даже если параметр `timestamp` в запросе присутствует.  
Вероятнее всего, некорректный формат параметра `timestamp`. Обратите внимание на url-encoding символов.  
Пример корректного параметра `timestamp`: `timestamp=2021.02.12+00%3A15%3A26+%2B0300`.

- После прохождения авторизации в ЕСИА не происходит возвращение в приложение.

Некорректно сформирован параметр `redirect_uri`. Обратите внимание на url-encoding символов.  
Пример корректного параметра `redirect_uri`: `redirect_uri=http%3A%2F%2Flocalhost%3A8080%2Fesia_return`.

- ESIA-007019: OAuthErrorEnum.noGrants

На этапе запроса авторизационного кода был включён scope, который отсутствует в заявке на подключение информационной
системы к ЕСИА.  
Для расширения списка scope необходимо отправить заявку в соответствии с регламентом ЕСИА
https://digital.gov.ru/ru/documents/4244/ п.11 на изменение параметров подключения информационной системы к ЕСИА, указав
необходимый набор scope.

## Сноски

1. Единицы измерения Duration: ns, us, ms, s, m, h, d - наносекунды, микросекунды, миллисекунды, секунды, минуты, часы,
   дни соответственно.
